<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
    포인트 환급 요청 Mapper.xml
    @author : sehui
    @fileName : PointReqMapper.xml
    @since : 250828
    @history
     - 250828 | sehui | 포인트 환급 요청 목록 조회 기능 추가
     - 250828 | sehui | 포인트 환급 요청 단건 조회 기능 추가
     - 250828 | sehui | 포인트 환급 요청 상태 변경 기능 추가
     - 250829 | sehui | 페이징 처리를 위한 전체 포인트 환급 요청의 수 조회 기능 추가
     - 250829 | sehui | 목록 조회 기능에 검색 조건, 페이징 기능 추가
     - 250912 | sehui | 포인트 환급 요청 금액 조회 기능 추가
-->

<mapper namespace="com.petcoin.mapper.PointReqMapper">

    <resultMap id="pointReqMap" type="com.petcoin.dto.PointRequestDto">
        <id property="requestId" column="request_id" />
        <result property="memberId" column="member_id" />
        <result property="phone" column="phone" />
        <result property="requestAmount" column="request_amount" />
        <result property="bankName" column="bank_name" />
        <result property="accountNumber" column="account_number" />
        <result property="accountHolder" column="account_holder" />
        <result property="requestStatus" column="request_status" />
        <result property="requestAt" column="request_at" />
        <result property="processedAt" column="processed_at" />
        <result property="note" column="note" />
    </resultMap>

    <!-- 포인트 환급 요청 목록 조회 (페이징 + 검색 조건) -->
    <select id="findPointRequestsWithPaging" resultMap="pointReqMap">
        SELECT
            pr.request_id,
            pr.member_id,
            m.phone,
            pr.request_amount,
            pr.bank_name,
            pr.account_number,
            pr.account_holder,
            pr.request_status,
            pr.request_at,
            pr.processed_at,
            pr.note
        FROM point_request pr
        LEFT JOIN member m ON pr.member_id = m.member_id
        <where>
            <include refid="pointReqSearchCondition"></include>
        </where>
        ORDER BY pr.request_at DESC
        LIMIT #{amount} OFFSET #{offset}
    </select>

    <!-- 검색 조건(핸드폰 번호, 요청 처리 상태 -->
    <sql id="pointReqSearchCondition">
        <if test="requestStatus != null and requestStatus != ''">
            AND pr.request_status = #{requestStatus}
        </if>
        <if test="phone != null and phone != ''">
            AND m.phone LIKE CONCAT ('%', #{phone}, '%')
        </if>
    </sql>

    <!-- 포인트 환급 요청 단건 조회 -->
    <select id="findPointRequestById" resultMap="pointReqMap">
        SELECT
            pr.request_id,
            pr.member_id,
            m.phone,
            pr.request_amount,
            pr.bank_name,
            pr.account_number,
            pr.account_holder,
            pr.request_status,
            pr.request_at,
            pr.processed_at,
            pr.note
        FROM point_request pr
        LEFT JOIN member m ON pr.member_id = m.member_id
        WHERE pr.request_id = #{requestId}
    </select>

    <!-- 포인트 환급 요청 상태 변경 -->
    <update id="updatePointRequestStatus">
        UPDATE point_request
        SET
            request_status = #{requestStatus},
            processed_at = NOW(),
            note = #{note}
        WHERE request_id = #{requestId}
    </update>

    <!-- 전체 포인트 환급 요청의 수 -->
    <select id="getTotalPointRequests" resultType="int">
        SELECT count(*)
        FROM point_request
    </select>

    <!-- 포인트 환급 요청 -->
    <insert id="requestRefund" parameterType="com.petcoin.domain.PointReqVO" useGeneratedKeys="true" keyProperty="requestId">
        insert into point_request(request_id, member_id, request_amount, bank_name, account_number, account_holder, request_status, request_at)
        values (#{requestId}, #{memberId}, #{requestAmount}, #{bankName}, #{accountNumber}, #{accountHolder}, 'PENDING', now())
    </insert>

    <!-- 포인트 환급 금액 조회 -->
    <select id="getPendingRefundAmount" resultType="int">
        SELECT COALESCE(SUM(request_amount), 0)
        FROM point_request
        WHERE member_id = #{memberId} AND request_status = 'PENDING'
    </select>

</mapper>