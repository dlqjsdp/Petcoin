-- 데이터베이스 생성
CREATE DATABASE petcoin;
-- 프로젝트 DB (petcoin) 선택
use petcoin;

-- 회원 가입 테이블
create table member (
    member_id BIGINT AUTO_INCREMENT PRIMARY KEY, -- 회원 고유변호(기본키)
    phone VARCHAR(13) NOT NULL UNIQUE, -- 연락처(중복불가)
    role ENUM('USER','ADMIN') NOT NULL DEFAULT 'USER', -- 권한
    password VARCHAR(255) NOT NULL, -- 비밀번호
);

-- 안내사항 테이블
create table notice (
	notice_id BIGINT AUTO_INCREMENT PRIMARY KEY, -- 게시글 고유변호(기본키)
    member_id BIGINT NOT NULL, -- 작성자 ID(외래키)
    title VARCHAR(255) NOT NULL, -- 게시글 제목
    content VARCHAR(5000) NOT NULL, -- 게시글 내용
    view_count INT NOT NULL DEFAULT 0, -- 조회수(초기값 0)
    created_at DATETIME NOT NULL DEFAULT (CURRENT_TIMESTAMP), -- 게시글 등록일
    updated_at DATETIME NOT NULL DEFAULT (CURRENT_TIMESTAMP), -- 게시글 수정일
    FOREIGN KEY (member_id) REFERENCES member(member_id)
);

-- 페트병 무인회수기 위치 테이블
create table pet_recycle (
    recycle_id BIGINT AUTO_INCREMENT PRIMARY KEY, -- 회수기 고유번호(기본키)
    recycle_name VARCHAR(200) NOT NULL, -- 회수기 위치 명칭
    address VARCHAR(255) NOT NULL, -- 설치 주소
    latitude DECIMAL(10,7) NOT NULL, -- 위도
    longitude DECIMAL(10,7) NOT NULL, -- 경도
    recycle_tel VARCHAR(13), -- 설치된 장소 연락처
    sido VARCHAR(20), -- 시
    sigungu VARCHAR(30), -- 구
    dong VARCHAR(40) -- 동
);

-- 포인트 내역 테이블
create table point_history (
	history_id BIGINT AUTO_INCREMENT PRIMARY KEY,		-- 포인트 내역 고유번호(PK)
    member_id BIGINT NOT NULL,			-- 회원 고유번호(FK)
    point_change INT NOT NULL DEFAULT 0,		-- 포인트 변화량
    point_balance INT NOT NULL DEFAULT 0, 		-- 포인트 잔액
    action_type ENUM('EARN', 'USE', 'ADJUST') NOT NULL, 		-- 거래 유형
    description VARCHAR(255) DEFAULT NULL, 		-- 거래 상세 설명
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,		-- 거래 일자
    FOREIGN KEY (member_id) REFERENCES member(member_id) ON DELETE CASCADE
);

-- 포인트 환급 요청 테이블
create table point_request (
	request_id BIGINT AUTO_INCREMENT PRIMARY KEY,		-- 포인트 환급 요청 고유번호(PK)
    member_id BIGINT NOT NULL,		-- 회원 고유번호(FK)
    request_amount INT NOT NULL,		-- 환급 요청 금액
    bank_name VARCHAR(50) NOT NULL,		-- 은행명
    account_number VARCHAR(50) NOT NULL,		-- 계좌번호
    account_holder VARCHAR(50) NOT NULL,		-- 예금주명
    request_status ENUM('PENDING', 'APPROVED', 'COMPLETED', 'REJECTED') NOT NULL DEFAULT 'PENDING',			-- 진행 상태
    request_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,		-- 요청 시각
    processed_at DATETIME DEFAULT NULL,		-- 요청 처리 완료 시각
    note VARCHAR(255) DEFAULT NULL,		-- 요청 처리 사유
    FOREIGN KEY (member_id) REFERENCES member(member_id) ON DELETE RESTRICT
);

-- 키오스크 장치 정보(kiosk)
CREATE TABLE IF NOT EXISTS kiosk (
  kiosk_id BIGINT AUTO_INCREMENT PRIMARY KEY, -- 장치 PK
  name VARCHAR(100)  NOT NULL, -- 표시명
  location VARCHAR(255)  NOT NULL, -- 설치 매장/주소
  lat DECIMAL(10,7) NULL, -- 위도
  lng DECIMAL(10,7) NULL, -- 경도
  status ENUM('ONLINE','OFFLINE','MAINT') NOT NULL DEFAULT 'ONLINE',
  sw_version VARCHAR(50)   NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 생성 시각
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 마지막 수정 시각
  is_deleted TINYINT(1) NOT NULL DEFAULT 0 -- 소프트 삭제 (0=정상, 1=삭제)
);

-- 키오스크 가동 이력(kiosk_run)
CREATE TABLE IF NOT EXISTS kiosk_run (
  run_id BIGINT AUTO_INCREMENT PRIMARY KEY, -- 세션 PK
  kiosk_id BIGINT NOT NULL, -- FK
  member_id BIGINT NULL, -- FK
  status ENUM('RUNNING','COMPLETED','CANCELLED') NOT NULL DEFAULT 'RUNNING',
  started_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  ended_at  DATETIME NULL,
  FOREIGN KEY (kiosk_id) REFERENCES kiosk(kiosk_id),
  FOREIGN KEY (member_id) REFERENCES member(member_id)
);

CREATE INDEX idx_kiosk_run_kiosk_id ON kiosk_run(kiosk_id);

-- RUNNING 여부 체크/범위잠금 정확도 ↑
CREATE INDEX idx_kiosk_run_kiosk_status ON kiosk_run (kiosk_id, status);

-- 목록 조회에서 최근순 정렬도 자주 쓰면 같이(선택)
CREATE INDEX idx_kiosk_run_kiosk_status_started ON kiosk_run (kiosk_id, status, started_at DESC);

-- 불량 사유 및 안내 메시지(pet_rejection)
create table pet_rejection (
pet_rejection_id bigint primary key,
pet_rejection_reason varchar(1000) not null,
pet_rejection_info varchar(1000) not null
);

-- 페트병 회수 기록 내역(pet_collection_log)
create table pet_collection_log (
pet_collection_id BIGINT AUTO_INCREMENT PRIMARY KEY,
run_id bigint not null,
member_id bigint not null,
pet_rejection_id bigint not null,
ai_confidence double not null,
created_at datetime default CURRENT_TIMESTAMP not null,
is_collected boolean not null,
img_path varchar(1000),
FOREIGN KEY (run_id) REFERENCES kiosk_run(run_id),
FOREIGN KEY (pet_rejection_id) REFERENCES pet_rejection(pet_rejection_id),
FOREIGN KEY (member_id) REFERENCES member(member_id)
);

-- 정상 회수 페트병 개수 컬럼 추가
alter table kiosk_run add column total_pet int;